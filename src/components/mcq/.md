"use client"
import { useEffect, useRef, useState } from "react"
import {
  Progress,
  Button,
  Modal,
  Form,
  Input,
  Card,
  Row,
  Col,
  Typography,
  Space,
  Tag,
  Tooltip,
  Collapse,
  Badge,
  Divider,
  notification,
} from "antd"
import {
  ArrowLeftOutlined,
  BookOutlined,
  CloseOutlined,
  FlagOutlined,
  SaveOutlined,
  LeftOutlined,
  RightOutlined,
  EyeOutlined,
  SwapOutlined,
  CheckCircleOutlined,
  CloseCircleOutlined,
  InfoCircleOutlined,
} from "@ant-design/icons"
import FsLightbox from "fslightbox-react"
import { MathJax, MathJaxContext } from "better-react-mathjax"
import Timer from "./Timer"
import Axios from "@/lib/Axios"
import { useRouter } from "next/navigation"
import { useSession } from "next-auth/react"

const { Title, Text, Paragraph } = Typography
const { TextArea } = Input
const { Panel } = Collapse

const Mcqs = ({ subject, chapter }) => {
  const router = useRouter()
  const [correctMcq, setCorrectMcq] = useState([])
  const [wrongMcq, setWrongMcq] = useState([])
  const [attempted, setAttempted] = useState([])
  const [showMockModel, setShowMockModel] = useState(false)
  const [loading, setLoading] = useState(false)
  const { data: session } = useSession()
  const userId = session?.user?.id

  const [lightboxController, setLightboxController] = useState({
    toggler: false,
    sourceIndex: 0,
  })

  const toggleLightbox = () => {
    setLightboxController({
      ...lightboxController,
      toggler: !lightboxController.toggler,
    })
  }

  const [data, setData] = useState([])
  const [mcqs, setMcqs] = useState([])
  const [sideBarOpen, setSidebarOpen] = useState(false)
  const [bioCorrectCout, setBioCorrectCount] = useState(0)
  const [chemCorrectCout, setChemCorrectCount] = useState(0)
  const [phyCorrectCount, setPhyCorrectCount] = useState(0)
  const [engCorrectCount, setEngCorrectCount] = useState(0)
  const [logicCorrectCount, setLogicCorrectCount] = useState(0)
  const [mockPercentageCount, setMockPercentageCout] = useState(0)
  const [showResultModel, setShowResultModel] = useState(false)

  const showNotification = (message, type = "info") => {
    notification[type]({
      message: message,
      placement: "top",
      duration: 4,
    })
  }

  useEffect(() => {
    setMcqs(data?.map((mcq) => ({ ...mcq, selected: null, lock: false })))
  }, [data])

  const saveMcqData = async () => {
    if (correctMcq.length > 0 || wrongMcq.length > 0) {
      try {
        if (subject === "mock") {
          return router.back()
        }
        const response = await Axios.put("/mcq/solved", { correctMcq, wrongMcq, userId })
        if (response.data.acknowledged) {
          showNotification("Check Stats In Dashboard", "success")
        }
      } catch (error) {}
    } else {
      showNotification("Solved MCQ's Saved", "info")
    }
  }

  const handleBookmarked = async () => {
    const res = await Axios.put("/mcq/bookmark", { mcqId: mcqs[index]._id })
    if (res.status == 200) {
      showNotification("MCQ Bookmarked", "success")
    } else {
      showNotification("Something Went Wrong", "error")
    }
  }

  const [index, setIndex] = useState(0)
  const alphabets = ["A", "B", "C", "D"]
  const [isFlip, setIsFlip] = useState(false)

  const [testStart, setTestStart] = useState(true)
  const [isReportModalOpen, setisReportModalOpen] = useState(false)
  const [reportData, setReportData] = useState({ msg: "" })
  const [reportForm] = Form.useForm()

  const handleReportChange = (e) => {
    const { name, value } = e.target
    setReportData({ ...reportData, [name]: value, question: mcqs[index]?.question })
  }

  const handleReport = async () => {
    if (reportData.msg == "") {
      showNotification("Reason is required field", "warning")
      return
    }
    try {
      const response = await Axios.post("/report", reportData)
      if (response.status == 201) {
        setisReportModalOpen(false)
        setReportData({ msg: "" })
        reportForm.resetFields()
        showNotification("We will review it shortly", "success")
      } else {
        showNotification("Something Went Wrong", "error")
      }
    } catch (error) {
      showNotification("Something Went Wrong", "error")
    }
  }

  const ref1 = useRef()
  const ref2 = useRef()
  const ref3 = useRef()
  const ref4 = useRef()
  const refArray = [ref1, ref2, ref3, ref4]

  useEffect(() => {
    if (mcqs[index]?.selected != null) {
      if (mcqs[index].correctOption === mcqs[index].selected) {
        refArray[mcqs[index].selected - 1].current.classList.add("correct")
      } else {
        refArray[mcqs[index].selected - 1].current.classList.add("wrong")
      }
    }
  }, [mcqs, index])

  const checkAns = (e, ans) => {
    if (mcqs[index].lock == false) {
      setMcqs((prevMcqs) => {
        const updatedMcqs = [...prevMcqs]
        updatedMcqs[index].lock = true
        updatedMcqs[index].selected = ans
        return updatedMcqs
      })

      if (mcqs[index].correctOption == ans) {
        e.target.classList.add("correct")
        setCorrectMcq((prevMcq) => [...prevMcq, mcqs[index]._id])
        setAttempted([...attempted, index])

        if (subject == "mock") {
          if (index < 68) {
            setBioCorrectCount((e) => e + 1)
          } else if (index < 122) {
            setChemCorrectCount((e) => e + 1)
          } else if (index < 176) {
            setPhyCorrectCount((e) => e + 1)
          } else if (index < 194) {
            setEngCorrectCount((e) => e + 1)
          } else if (index < 200) {
            setLogicCorrectCount((e) => e + 1)
          }
        }
      } else {
        mcqs[index].lock = true
        e.target.classList.add("wrong")
        refArray[mcqs[index].correctOption - 1].current.classList.add("correct")
        setWrongMcq((prevMcq) => [...prevMcq, mcqs[index]._id])
      }
    }
  }

  const nextOption = () => {
    setIsFlip(false)
    if (index < mcqs?.length - 1) {
      setIndex(index + 1)
      refArray.map((e) => {
        e.current.classList.remove("correct")
        e.current.classList.remove("wrong")
      })
    } else {
      if (subject === "mock") {
        setMockPercentageCout(bioCorrectCout + phyCorrectCount + chemCorrectCout + engCorrectCount + logicCorrectCount)
        return showMockResult()
      }
      showMockResult()
      saveMcqData()
    }
  }

  const showMockResult = () => {
    setSidebarOpen(false)
    setShowMockModel(true)
  }

  const prevOption = () => {
    setIsFlip(false)
    if (index > 0) {
      setIndex(index - 1)
      refArray.map((e) => {
        e.current.classList.remove("wrong")
        e.current.classList.remove("correct")
        return null
      })
    } else {
      setIndex(0)
    }
  }

  const handleSetIndex = (i) => {
    setIsFlip(false)
    setIndex(i)
    refArray.map((e) => {
      e.current.classList.remove("wrong")
      e.current.classList.remove("correct")
      return null
    })
  }

  const handleSaveAndExit = () => {
    if (subject == "mock") {
      return router.back()
    }
    saveMcqData()
  }

  const handleFlip = () => {
    const da = mcqs[index]
    if (da.lock) {
      setIsFlip(!isFlip)
    } else {
      showNotification("Attempt MCQ To See Explanation", "info")
    }
  }

  const handleMockPreview = () => {
    setShowResultModel(true)
  }

  const config = {
    loader: { load: ["[tex]/ams"] },
    tex: {
      inlineMath: [
        ["$", "$"],
        ["$$", "$$"],
      ],
      displayMath: [
        ["$$", "$$"],
        ["\\[", "\\]"],
      ],
    },
  }

  const getQuestionStatusColor = (mcqId, currentIndex) => {
    if (correctMcq.includes(mcqId)) return "#52c41a"
    if (wrongMcq.includes(mcqId)) return "#ff4d4f"
    if (currentIndex === index) return "#1890ff"
    return "#f0f0f0"
  }

  const getQuestionStatusTextColor = (mcqId, currentIndex) => {
    if (correctMcq.includes(mcqId) || wrongMcq.includes(mcqId)) return "#fff"
    if (currentIndex === index) return "#fff"
    return "#666"
  }

  return (
    <MathJaxContext version={3} config={config}>
      <div style={{ minHeight: "100vh", background: "#f5f5f5" }}>
        {/* Header */}
        <Card
          style={{
            margin: "16px",
            borderRadius: "12px",
            boxShadow: "0 2px 8px rgba(0,0,0,0.1)",
          }}
        >
          <Row justify="space-between" align="middle">
            <Col>
              <Button
                type="text"
                icon={<ArrowLeftOutlined />}
                onClick={() => router.back()}
                style={{
                  display: "flex",
                  alignItems: "center",
                  gap: "8px",
                  color: "#1890ff",
                  fontWeight: 500,
                }}
              >
                Back
              </Button>
            </Col>
            <Col>
              <Button
                type="primary"
                icon={<SaveOutlined />}
                onClick={handleSaveAndExit}
                style={{
                  display: "flex",
                  alignItems: "center",
                  gap: "8px",
                  borderRadius: "8px",
                }}
              >
                Save & Exit
              </Button>
            </Col>
          </Row>

          <div style={{ marginTop: "16px" }}>
            <Progress
              percent={((index + 1) / mcqs.length) * 100}
              strokeColor={{
                "0%": "#108ee9",
                "100%": "#87d068",
              }}
              style={{ marginBottom: "8px" }}
            />
          </div>
        </Card>

        {/* Timer */}
        {subject === "mock" && (
          <Card
            style={{
              margin: "0 16px 16px 16px",
              textAlign: "center",
              borderRadius: "12px",
              background: "linear-gradient(135deg, #667eea 0%, #764ba2 100%)",
              color: "white",
              border: "none",
            }}
          >
            <Title level={3} style={{ color: "white", margin: 0 }}>
              {loading ? (
                "Calculating time..."
              ) : (
                <Timer initialTimeInMinutes={150} handleSaveAndExit={handleSaveAndExit} />
              )}
            </Title>
          </Card>
        )}

        <Row gutter={16} style={{ margin: "0 16px" }}>
          {/* Sidebar */}
          <Col
            xs={24}
            md={6}
            style={{
              position: sideBarOpen ? "fixed" : "relative",
              zIndex: sideBarOpen ? 1000 : "auto",
              left: sideBarOpen ? 0 : "auto",
              top: sideBarOpen ? 0 : "auto",
              height: sideBarOpen ? "100vh" : "auto",
              background: sideBarOpen ? "white" : "transparent",
              padding: sideBarOpen ? "16px" : "0",
              overflowY: sideBarOpen ? "auto" : "visible",
            }}
          >
            <Card
              title="Questions Overview"
              style={{
                borderRadius: "12px",
                boxShadow: "0 2px 8px rgba(0,0,0,0.1)",
              }}
              extra={
                <Button
                  type="text"
                  icon={<CloseOutlined />}
                  onClick={() => setSidebarOpen(false)}
                  style={{ display: sideBarOpen ? "block" : "none" }}
                />
              }
            >
              <Row gutter={[8, 8]}>
                {mcqs.map((mcq, i) => (
                  <Col span={4} key={i}>
                    <Button
                      size="small"
                      onClick={() => handleSetIndex(i)}
                      style={{
                        width: "100%",
                        height: "32px",
                        background: getQuestionStatusColor(mcq._id, i),
                        color: getQuestionStatusTextColor(mcq._id, i),
                        border: "none",
                        borderRadius: "6px",
                        fontWeight: i === index ? "bold" : "normal",
                      }}
                    >
                      {i + 1}
                    </Button>
                  </Col>
                ))}
              </Row>
            </Card>
          </Col>

          {/* Main Content */}
          <Col xs={24} md={18}>
            <Card
              style={{
                borderRadius: "12px",
                boxShadow: "0 2px 8px rgba(0,0,0,0.1)",
                minHeight: "600px",
              }}
            >
              {/* Question Header */}
              <Row justify="space-between" align="middle" style={{ marginBottom: "24px" }}>
                <Col>
                  <Space>
                    <Badge count={index + 1} style={{ backgroundColor: "#1890ff" }}>
                      <Text strong style={{ fontSize: "16px" }}>
                        Question {index + 1}/{mcqs?.length}
                      </Text>
                    </Badge>
                    {mcqs[index]?.info && (
                      <Tag color="blue" style={{ textTransform: "capitalize" }}>
                        {mcqs[index]?.info}
                      </Tag>
                    )}
                  </Space>
                </Col>
                <Col>
                  <Space>
                    <Tag
                      color={
                        mcqs[index]?.difficulty === "easy"
                          ? "green"
                          : mcqs[index]?.difficulty === "medium"
                            ? "orange"
                            : "red"
                      }
                      style={{ textTransform: "capitalize" }}
                    >
                      {mcqs[index]?.difficulty === "medium" ? "Moderate" : mcqs[index]?.difficulty}
                    </Tag>
                    <Tooltip title="Bookmark this question">
                      <Button
                        type="text"
                        icon={<BookOutlined />}
                        onClick={handleBookmarked}
                        style={{ color: "#1890ff" }}
                      />
                    </Tooltip>
                  </Space>
                </Col>
              </Row>

              {/* Question Content */}
              <div style={{ marginBottom: "24px" }}>
                <Title level={4} style={{ color: "#1890ff", marginBottom: "16px" }}>
                  Question:
                </Title>
                <div
                  style={{
                    background: "#fafafa",
                    padding: "16px",
                    borderRadius: "8px",
                    border: "1px solid #d9d9d9",
                  }}
                >
                  <MathJax dynamic={true} style={{ fontSize: "18px", lineHeight: "1.6" }}>
                    {mcqs[index]?.question}
                  </MathJax>
                </div>
              </div>

              {loading ? (
                <div
                  style={{
                    height: "300px",
                    display: "flex",
                    alignItems: "center",
                    justifyContent: "center",
                    fontSize: "16px",
                    color: "#666",
                  }}
                >
                  Please wait a moment...
                </div>
              ) : (
                <div>
                  {/* Question/Explanation Card */}
                  <Card
                    style={{
                      borderRadius: "8px",
                      border: "1px solid #d9d9d9",
                      minHeight: "300px",
                    }}
                  >
                    {!isFlip ? (
                      // Options
                      <div>
                        <Title level={5} style={{ marginBottom: "16px", color: "#666" }}>
                          Choose the correct answer:
                        </Title>
                        <Space direction="vertical" size="middle" style={{ width: "100%" }}>
                          {mcqs[index]?.options.map((option, optionIndex) => (
                            <div
                              key={optionIndex}
                              ref={refArray[optionIndex]}
                              onClick={(e) => checkAns(e, optionIndex + 1)}
                              style={{
                                padding: "12px 16px",
                                border: "2px solid #d9d9d9",
                                borderRadius: "8px",
                                cursor: "pointer",
                                transition: "all 0.3s ease",
                                background: "#fff",
                              }}
                              className="mcq-option"
                            >
                              <Space>
                                <Tag
                                  style={{
                                    minWidth: "24px",
                                    textAlign: "center",
                                    userSelect: "none",
                                    pointerEvents: "none",
                                  }}
                                >
                                  {alphabets[optionIndex]}
                                </Tag>
                                <MathJax
                                  dynamic={true}
                                  style={{
                                    userSelect: "none",
                                    pointerEvents: "none",
                                    fontSize: "16px",
                                  }}
                                >
                                  {option}
                                </MathJax>
                              </Space>
                            </div>
                          ))}
                        </Space>
                      </div>
                    ) : (
                      // Explanation
                      <div>
                        <Row gutter={24}>
                          <Col xs={24} md={16}>
                            <Title level={5} style={{ color: "#1890ff", marginBottom: "16px" }}>
                              Explanation
                            </Title>
                            <div
                              style={{
                                background: "#f6ffed",
                                padding: "16px",
                                borderRadius: "8px",
                                border: "1px solid #b7eb8f",
                              }}
                            >
                              <MathJax
                                dynamic={true}
                                style={{
                                  fontSize: "16px",
                                  whiteSpace: "pre-line",
                                  lineHeight: "1.6",
                                }}
                              >
                                {mcqs[index]?.explain || "Explanation not available yet"}
                              </MathJax>
                            </div>
                          </Col>
                          <Col xs={24} md={8}>
                            <Title level={5} style={{ color: "#1890ff", marginBottom: "16px" }}>
                              Reference Image
                            </Title>
                            {mcqs[index]?.imageUrl && (
                              <img
                                src={mcqs[index]?.imageUrl || "/placeholder.svg"}
                                alt="Reference"
                                style={{
                                  width: "100%",
                                  maxHeight: "200px",
                                  objectFit: "contain",
                                  cursor: "pointer",
                                  borderRadius: "8px",
                                  border: "1px solid #d9d9d9",
                                }}
                                onClick={toggleLightbox}
                              />
                            )}
                          </Col>
                        </Row>
                      </div>
                    )}
                  </Card>

                  {/* Action Buttons */}
                  <Row justify="space-between" align="middle" style={{ marginTop: "24px" }}>
                    <Col>
                      <Button
                        icon={<LeftOutlined />}
                        onClick={prevOption}
                        disabled={index === 0}
                        style={{ borderRadius: "8px" }}
                      >
                        Previous
                      </Button>
                    </Col>

                    <Col>
                      <Space>
                        <Tooltip title="Report this question">
                          <Button
                            type={isReportModalOpen ? "primary" : "default"}
                            icon={<FlagOutlined />}
                            onClick={() => setisReportModalOpen(!isReportModalOpen)}
                            style={{ borderRadius: "8px" }}
                          />
                        </Tooltip>

                        {chapter !== "test" && (
                          <Button icon={<SwapOutlined />} onClick={handleFlip} style={{ borderRadius: "8px" }}>
                            {isFlip ? "Question" : "Explanation"}
                          </Button>
                        )}

                        <Button
                          type={sideBarOpen ? "primary" : "default"}
                          icon={<EyeOutlined />}
                          onClick={() => setSidebarOpen(!sideBarOpen)}
                          style={{ borderRadius: "8px" }}
                        >
                          Overview
                        </Button>
                      </Space>
                    </Col>

                    <Col>
                      <Button
                        type="primary"
                        icon={<RightOutlined />}
                        onClick={nextOption}
                        style={{ borderRadius: "8px" }}
                      >
                        {index === mcqs?.length - 1 ? (subject === "mock" ? "View Result" : "Submit") : "Next"}
                      </Button>
                    </Col>
                  </Row>
                </div>
              )}
            </Card>
          </Col>
        </Row>

        {/* Lightbox */}
        <FsLightbox toggler={lightboxController.toggler} sources={[mcqs[index]?.imageUrl]} zoomIncrement={0.1} />

        {/* Report Modal */}
        <Modal
          title="Report MCQ"
          open={isReportModalOpen}
          onCancel={() => setisReportModalOpen(false)}
          onOk={handleReport}
          okText="Report"
          okButtonProps={{ danger: true }}
          style={{ borderRadius: "12px" }}
        >
          <Form form={reportForm} layout="vertical">
            <Form.Item
              label="Reason (required)"
              name="msg"
              rules={[{ required: true, message: "Please provide a reason" }]}
            >
              <TextArea
                rows={4}
                onChange={handleReportChange}
                placeholder="Please describe the issue with this question..."
              />
            </Form.Item>
          </Form>
        </Modal>

        {/* Test Start Modal */}
        <Modal open={testStart} footer={null} closable={false} width={600} style={{ borderRadius: "12px" }}>
          <div style={{ textAlign: "center", padding: "24px" }}>
            <Title level={2} style={{ color: "#1890ff", marginBottom: "24px" }}>
              Test Instructions
            </Title>

            <Card style={{ textAlign: "left", marginBottom: "24px" }}>
              <ul style={{ fontSize: "16px", lineHeight: "2" }}>
                <li>You can select only one option per question</li>
                <li>Once an option is selected, it cannot be changed later</li>
                <li>You can solve only {subject === "mock" ? "200" : "100"} MCQs in one go</li>
                <li>
                  {subject === "mock"
                    ? "Check Mock-test result after completion"
                    : "Your data will enter the stats only if you submit or save the test"}
                </li>
              </ul>
            </Card>

            <Space size="large">
              <Button size="large" onClick={() => router.back()}>
                Quit
              </Button>
              <Button type="primary" size="large" onClick={() => setTestStart(false)} style={{ borderRadius: "8px" }}>
                Start Test
              </Button>
            </Space>
          </div>
        </Modal>

        {/* Result Modal */}
        <Modal open={showMockModel} footer={null} closable={false} width="90%" style={{ top: 20 }}>
          <div style={{ padding: "24px" }}>
            <Row gutter={24}>
              <Col xs={24} md={12}>
                <Card
                  style={{
                    textAlign: "center",
                    background: "linear-gradient(135deg, #667eea 0%, #764ba2 100%)",
                    color: "white",
                    border: "none",
                  }}
                >
                  <Title level={3} style={{ color: "white" }}>
                    Your Result
                  </Title>
                  <div
                    style={{
                      width: "120px",
                      height: "120px",
                      borderRadius: "50%",
                      background: "rgba(255,255,255,0.2)",
                      display: "flex",
                      flexDirection: "column",
                      alignItems: "center",
                      justifyContent: "center",
                      margin: "24px auto",
                      fontSize: "24px",
                      fontWeight: "bold",
                    }}
                  >
                    {subject === "mock" ? mockPercentageCount : correctMcq.length}
                    <div style={{ fontSize: "14px", fontWeight: "normal" }}>of {mcqs?.length}</div>
                  </div>

                  <Title level={4} style={{ color: "white" }}>
                    {subject === "mock"
                      ? mockPercentageCount < 100
                        ? "Needs Improvement"
                        : mockPercentageCount < 150
                          ? "Satisfactory"
                          : "Excellent"
                      : correctMcq.length < mcqs.length / 2
                        ? "Needs Improvement"
                        : correctMcq.length < mcqs.length / 1.33
                          ? "Satisfactory"
                          : "Excellent"}
                  </Title>

                  <Paragraph style={{ color: "rgba(255,255,255,0.9)" }}>
                    {subject === "mock"
                      ? mockPercentageCount < 100
                        ? "Consider utilizing tutoring resources and dedicating more time to study and practice."
                        : mockPercentageCount < 150
                          ? "Your performance is satisfactory, but there is potential for improvement."
                          : "You have demonstrated an excellent understanding of the material."
                      : correctMcq.length < mcqs.length / 2
                        ? "Consider utilizing tutoring resources and dedicating more time to study and practice."
                        : correctMcq.length < mcqs.length / 1.33
                          ? "Your performance is satisfactory, but there is potential for improvement."
                          : "You have demonstrated an excellent understanding of the material."}
                  </Paragraph>
                </Card>
              </Col>

              <Col xs={24} md={12}>
                <Card title="Summary" style={{ height: "100%" }}>
                  <Row gutter={[16, 16]}>
                    <Col span={12}>
                      <Card size="small" style={{ background: "#f6ffed", border: "1px solid #b7eb8f" }}>
                        <div style={{ textAlign: "center" }}>
                          <CheckCircleOutlined style={{ fontSize: "24px", color: "#52c41a" }} />
                          <div style={{ fontWeight: "bold", marginTop: "8px" }}>
                            {subject !== "mock" ? "Correct" : "Biology"}
                          </div>
                          <div style={{ fontSize: "18px", fontWeight: "bold", color: "#52c41a" }}>
                            {subject === "mock" ? `${bioCorrectCout}/68` : correctMcq?.length}
                          </div>
                        </div>
                      </Card>
                    </Col>

                    <Col span={12}>
                      <Card size="small" style={{ background: "#fff7e6", border: "1px solid #ffd591" }}>
                        <div style={{ textAlign: "center" }}>
                          <InfoCircleOutlined style={{ fontSize: "24px", color: "#fa8c16" }} />
                          <div style={{ fontWeight: "bold", marginTop: "8px" }}>
                            {subject !== "mock" ? "Unattempted" : "Chemistry"}
                          </div>
                          <div style={{ fontSize: "18px", fontWeight: "bold", color: "#fa8c16" }}>
                            {subject === "mock"
                              ? `${chemCorrectCout}/54`
                              : mcqs.length - (correctMcq?.length + wrongMcq?.length)}
                          </div>
                        </div>
                      </Card>
                    </Col>

                    <Col span={12}>
                      <Card size="small" style={{ background: "#fff2f0", border: "1px solid #ffccc7" }}>
                        <div style={{ textAlign: "center" }}>
                          <CloseCircleOutlined style={{ fontSize: "24px", color: "#ff4d4f" }} />
                          <div style={{ fontWeight: "bold", marginTop: "8px" }}>
                            {subject !== "mock" ? "Wrong" : "Physics"}
                          </div>
                          <div style={{ fontSize: "18px", fontWeight: "bold", color: "#ff4d4f" }}>
                            {subject === "mock" ? `${phyCorrectCount}/54` : wrongMcq?.length}
                          </div>
                        </div>
                      </Card>
                    </Col>

                    <Col span={12}>
                      <Card size="small" style={{ background: "#f0f5ff", border: "1px solid #adc6ff" }}>
                        <div style={{ textAlign: "center" }}>
                          <div style={{ fontSize: "24px", color: "#1890ff" }}>%</div>
                          <div style={{ fontWeight: "bold", marginTop: "8px" }}>
                            {subject !== "mock" ? "Percentage" : "English"}
                          </div>
                          <div style={{ fontSize: "18px", fontWeight: "bold", color: "#1890ff" }}>
                            {subject === "mock"
                              ? `${engCorrectCount}/18`
                              : `${((correctMcq?.length / mcqs.length) * 100).toFixed(1)}%`}
                          </div>
                        </div>
                      </Card>
                    </Col>

                    {subject === "mock" && (
                      <Col span={24}>
                        <Card size="small" style={{ background: "#f9f0ff", border: "1px solid #d3adf7" }}>
                          <div style={{ textAlign: "center" }}>
                            <div style={{ fontWeight: "bold" }}>Logical Reasoning</div>
                            <div style={{ fontSize: "18px", fontWeight: "bold", color: "#722ed1" }}>
                              {logicCorrectCount}/6
                            </div>
                          </div>
                        </Card>
                      </Col>
                    )}
                  </Row>

                  <div style={{ marginTop: "24px", textAlign: "center" }}>
                    <Space>
                      <Button type="primary" onClick={() => setShowResultModel(true)} style={{ borderRadius: "8px" }}>
                        Review
                      </Button>
                      <Button onClick={() => router.back()} style={{ borderRadius: "8px" }}>
                        Continue
                      </Button>
                    </Space>
                  </div>
                </Card>
              </Col>
            </Row>
          </div>
        </Modal>

        {/* Review Modal */}
        <Modal
          open={showResultModel}
          footer={null}
          onCancel={() => setShowResultModel(false)}
          width="95%"
          style={{ top: 20 }}
        >
          <div style={{ padding: "16px" }}>
            <Title level={3} style={{ textAlign: "center", marginBottom: "24px" }}>
              Review Your Attempted MCQs
            </Title>

            {subject !== "mock" ? (
              <Collapse>
                <Panel header="Review MCQs" key="1">
                  <Space direction="vertical" size="large" style={{ width: "100%" }}>
                    {mcqs.map((ele, i) => (
                      <Card key={i} size="small">
                        <div style={{ marginBottom: "16px" }}>
                          <Text strong>Q:{i + 1}) </Text>
                          <MathJax inline>{ele.question}</MathJax>
                        </div>

                        <Space direction="vertical" size="small" style={{ width: "100%" }}>
                          {ele.options.map((option, optionIndex) => (
                            <div
                              key={optionIndex}
                              style={{
                                padding: "8px 12px",
                                borderRadius: "6px",
                                background:
                                  correctMcq.includes(ele._id) && optionIndex + 1 === ele.selected
                                    ? "#f6ffed"
                                    : wrongMcq.includes(ele._id) && optionIndex + 1 === ele.selected
                                      ? "#fff2f0"
                                      : "transparent",
                                border:
                                  correctMcq.includes(ele._id) && optionIndex + 1 === ele.selected
                                    ? "1px solid #b7eb8f"
                                    : wrongMcq.includes(ele._id) && optionIndex + 1 === ele.selected
                                      ? "1px solid #ffccc7"
                                      : "1px solid #f0f0f0",
                              }}
                            >
                              <Space>
                                <Tag>{alphabets[optionIndex]}</Tag>
                                <MathJax inline>{option}</MathJax>
                              </Space>
                            </div>
                          ))}
                        </Space>

                        <Row gutter={16} style={{ marginTop: "16px" }}>
                          <Col span={12}>
                            {correctMcq.includes(ele._id) && <Tag color="success">Correct</Tag>}
                            {wrongMcq.includes(ele._id) && <Tag color="error">Wrong</Tag>}
                            {!correctMcq.includes(ele._id) && !wrongMcq.includes(ele._id) && (
                              <Tag color="default">Not Attempted</Tag>
                            )}
                          </Col>
                          <Col span={12}>
                            {!correctMcq.includes(ele._id) && <Text>Correct option: {ele.correctOption}</Text>}
                          </Col>
                        </Row>

                        <Divider />
                        <div>
                          <Text strong style={{ color: "#666" }}>
                            Explanation:
                          </Text>
                          <div style={{ marginTop: "8px" }}>
                            <MathJax style={{ whiteSpace: "pre-line" }} inline>
                              {ele.explain || "Not available"}
                            </MathJax>
                          </div>
                        </div>
                      </Card>
                    ))}
                  </Space>
                </Panel>
              </Collapse>
            ) : (
              <Collapse>
                {["biology", "chemistry", "physics", "english", "logic"].map((subjectType) => (
                  <Panel header={subjectType.charAt(0).toUpperCase() + subjectType.slice(1)} key={subjectType}>
                    <Space direction="vertical" size="large" style={{ width: "100%" }}>
                      {mcqs
                        .filter((ele) => ele.subject === subjectType)
                        .map((ele, i) => (
                          <Card key={i} size="small">
                            <div style={{ marginBottom: "16px" }}>
                              <Text strong>Q:{i + 1}) </Text>
                              <MathJax inline>{ele.question}</MathJax>
                            </div>

                            <Space direction="vertical" size="small" style={{ width: "100%" }}>
                              {ele.options.map((option, optionIndex) => (
                                <div
                                  key={optionIndex}
                                  style={{
                                    padding: "8px 12px",
                                    borderRadius: "6px",
                                    background:
                                      correctMcq.includes(ele._id) && optionIndex + 1 === ele.selected
                                        ? "#f6ffed"
                                        : wrongMcq.includes(ele._id) && optionIndex + 1 === ele.selected
                                          ? "#fff2f0"
                                          : "transparent",
                                    border:
                                      correctMcq.includes(ele._id) && optionIndex + 1 === ele.selected
                                        ? "1px solid #b7eb8f"
                                        : wrongMcq.includes(ele._id) && optionIndex + 1 === ele.selected
                                          ? "1px solid #ffccc7"
                                          : "1px solid #f0f0f0",
                                  }}
                                >
                                  <Space>
                                    <Tag>{alphabets[optionIndex]}</Tag>
                                    <MathJax inline>{option}</MathJax>
                                  </Space>
                                </div>
                              ))}
                            </Space>

                            <Row gutter={16} style={{ marginTop: "16px" }}>
                              <Col span={12}>
                                {correctMcq.includes(ele._id) && <Tag color="success">Correct</Tag>}
                                {wrongMcq.includes(ele._id) && <Tag color="error">Wrong</Tag>}
                                {!correctMcq.includes(ele._id) && !wrongMcq.includes(ele._id) && (
                                  <Tag color="default">Not Attempted</Tag>
                                )}
                              </Col>
                              <Col span={12}>
                                {!correctMcq.includes(ele._id) && <Text>Correct option: {ele.correctOption}</Text>}
                              </Col>
                            </Row>

                            <Divider />
                            <div>
                              <Text strong style={{ color: "#666" }}>
                                Explanation:
                              </Text>
                              <div style={{ marginTop: "8px" }}>
                                <MathJax style={{ whiteSpace: "pre-line" }} inline>
                                  {ele.explain || "Not available"}
                                </MathJax>
                              </div>
                            </div>
                          </Card>
                        ))}
                    </Space>
                  </Panel>
                ))}
              </Collapse>
            )}
          </div>
        </Modal>
      </div>

      <style jsx>{`
        .mcq-option:hover {
          border-color: #1890ff !important;
          box-shadow: 0 2px 8px rgba(24, 144, 255, 0.2);
        }
        
        .mcq-option.correct {
          background: #f6ffed !important;
          border-color: #52c41a !important;
        }
        
        .mcq-option.wrong {
          background: #fff2f0 !important;
          border-color: #ff4d4f !important;
        }
      `}</style>
    </MathJaxContext>
  )
}

export default Mcqs
